# プロフィール保存機能デバッグガイド

## 修正内容

### 1. APIレスポンス構造の統一
- **問題**: `/api/profile` GET が `{success: true, profile: {...}}` を返すのに、`useProfile.ts` で `data.data` を参照
- **修正**: `data.profile` を参照するように変更

### 2. 画像URL処理の統一
- **問題**: データベース `avatar_url` ↔ フロントエンド `profileImageUrl` の不整合
- **修正**: `profile.avatarUrl` を優先して参照するように変更

### 3. 保存時フィールド名の統一
- **問題**: 保存時に `profileImageUrl` として送信していたが、API側で `avatarUrl` として処理
- **修正**: `avatarUrl` として統一

## 動作確認方法

### 1. 開発者ツールのコンソールログ確認
```
🔥 保存処理開始: [ユーザー名]
📡 API応答: 成功
✅ プロフィール更新API成功
🔄 データ再取得完了
🎉 保存成功 - 画面に反映されるはずです
```

### 2. プロフィール画像アップロード確認
```
1. 画像をアップロード
2. 画像が即座に表示される
3. 保存ボタンを押下
4. 成功メッセージが表示される
5. ページをリロードしても画像が維持される
```

### 3. データベース確認
```sql
SELECT 
  cfo_user_id,
  avatar_url,
  cfo_display_name,
  updated_at
FROM cfo_profiles 
WHERE cfo_user_id = '[ユーザーID]';
```

## トラブルシューティング

### 症状1: 保存後に画像が消える
- **原因**: `useProfile.ts` の API レスポンス構造不整合
- **確認**: ブラウザコンソールで `📄 プロフィール取得データ:` の内容を確認

### 症状2: 保存は成功するが再取得でエラー
- **原因**: `fetchProfile()` 関数の処理不具合
- **確認**: ネットワークタブで `/api/profile` GET リクエストの応答確認

### 症状3: アップロード成功後に保存失敗
- **原因**: フィールド名の不整合
- **確認**: 保存時のリクエストボディで `avatarUrl` フィールドが送信されているか確認

## 予想される動作

1. **画像アップロード**: 即座に画面に反映
2. **保存ボタン**: 成功メッセージと共に全データが保存
3. **再取得**: 保存されたデータが正しく取得される
4. **画面更新**: 保存された内容が正しく表示される

## 検証が必要な場合

認証済みユーザーでログインして以下の操作を実行：
1. プロフィールページにアクセス
2. 画像をアップロード
3. プロフィール情報を編集
4. 保存ボタンを押下
5. ページをリロード
6. 保存された内容が正しく表示されることを確認